<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{{ request.app.title }}</title>
  <link rel="stylesheet" href="{{ url_for('static', path='/styles.css') }}">
  
  <!-- BEGIN: AdSense + NPA default -->
  <script>
    // Default to Non-Personalised Ads until user consents
    window.requestNonPersonalizedAds = 1;
  </script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9219208012298253" crossorigin="anonymous"></script>
  <!-- END: AdSense -->
  
  <!-- AdSense Manager -->
  <script src="{{ url_for('static', path='/adsense-manager.js') }}"></script>
  <script>
    // Configuration passed from server
    window.adsenseConfig = {
      publisherId: 'ca-pub-9219208012298253',
      testMode: {{ adsense_test_mode|lower }},
      environment: '{{ environment }}',
      cookieConsentEnabled: true,
      showFallbackAds: {{ show_fallback_ads|lower }},
      productionReady: {{ production_ready|lower }}
    };
    
    // Debug function available on all pages
    window.debugAds = function() {
      console.log('=== AD DEBUG INFO ===');
      console.log('Config:', window.adsenseConfig);
      console.log('Manager exists:', !!window.adsenseManager);
      console.log('AdSense script loaded:', !!window.adsbygoogle);
      console.log('NPA setting:', window.requestNonPersonalizedAds);
      
      const ads = document.querySelectorAll('.adsbygoogle');
      console.log('Ad slots found:', ads.length);
      
      ads.forEach((ad, i) => {
        console.log(`Ad ${i+1}:`, {
          element: ad,
          hasContent: ad.innerHTML.trim() !== '',
          isFallback: !!ad.dataset.fallbackAd,
          client: ad.dataset.adClient,
          slot: ad.dataset.adSlot
        });
      });
      
      if (window.adsenseManager) {
        console.log('Forcing fallback ads...');
        window.adsenseManager.showAllFallbackAds();
      }
    };
  </script>
</head>
<body>
  <!-- Minimal cookie banner -->
  <div id="cookie-banner" style="display:none; position:sticky; bottom:0; background:#111; color:#fff; padding:10px; z-index:9999;">
    Demo: AdSense consent system for educational platforms. Allow personalised ads cookies?
    <button id="cookie-accept">Allow</button>
    <button id="cookie-reject">No, thanks</button>
    <a href="{{ url_for('privacy') }}" style="color:#ffd166;">Learn more</a>
  </div>
  <script>
  (function () {
    const key = 'uni_cookie_ads';
    const banner = document.getElementById('cookie-banner');
    const choice = localStorage.getItem(key);
    if (!choice) banner.style.display = 'block';
    document.getElementById('cookie-accept').onclick = function(){
      localStorage.setItem(key,'accept');
      window.requestNonPersonalizedAds = 0;
      banner.style.display='none';
      // Notify AdSense manager of consent change instead of re-initializing
      console.log('User accepted cookies - switched to personalized ads');
      if (window.adsenseManager) {
        window.adsenseManager.cookieConsentGiven = true;
      }
    };
    document.getElementById('cookie-reject').onclick = function(){
      localStorage.setItem(key,'reject');
      window.requestNonPersonalizedAds = 1;
      banner.style.display='none';
    };
  })();
  </script>
  
  <div class="ribbon">
    Demo: AdSense Integration for Educational Platforms
    <a href="{{ url_for('privacy') }}">Learn more</a>
  </div>

  <header class="container">
    <h1>Music Connect â€” Demo Platform</h1>
    <p style="margin: 8px 0; color: #666; font-size: 14px;">ðŸ§ª AdSense Integration Demonstration Site</p>
    <nav style="margin-top: 16px; padding-bottom: 16px; border-bottom: 1px solid #eee;">
      <a href="{{ url_for('home') }}" style="margin-right: 24px;">Home</a>
      <a href="{{ url_for('about') }}" style="margin-right: 24px;">About</a>
      <a href="{{ url_for('mentors') }}" style="margin-right: 24px;">Mentors</a>
      <a href="{{ url_for('privacy') }}">Privacy</a>
    </nav>
  </header>

  <main class="container">
    {% block content %}{% endblock %}
  </main>

  <footer class="container footer">
    <p>&copy; {{ request.app.title }} â€” <a href="{{ url_for('privacy') }}">Privacy & Ads</a></p>
  </footer>
</body>
</html>
